<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Editar Perfil</title>
    <link rel="stylesheet" href="painel.css">
</head>

<body>
    <div class="panel">
        <h2>‚úèÔ∏è Editar Perfil</h2>

        <form id="updateForm">
            <label for="updateName">Nome Completo:</label>
            <input type="text" id="updateName" required>

            <label for="updateEmail">Email:</label>
            <input type="email" id="updateEmail">

            <label for="updatePassword">Nova Senha (opcional):</label>
            <input type="password" id="updatePassword">

            <label for="updatePhone">Telefone:</label>
            <input type="text" id="updatePhone">

            <label for="updateExperience">Experi√™ncia:</label>
            <textarea id="updateExperience"></textarea>

            <label for="updateEducation">Forma√ß√£o:</label>
            <textarea id="updateEducation"></textarea>

            <button type="submit">üíæ Salvar Altera√ß√µes</button>
            <button type="button" id="cancelBtn" class="secondary">‚¨ÖÔ∏è Cancelar</button>
        </form>

        <h2>üì° Resposta do Servidor</h2>
        <pre id="responseArea">Aguardando resposta...</pre>
    </div>

    <script src="api.js"></script>
    <script>
        const responseArea = document.getElementById('responseArea');
        let userId = null;

        function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch {
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const token = sessionStorage.getItem('jwtToken');
            if (!token) return (window.location.href = 'login.html');

            const payload = parseJwt(token);
            if (!payload?.sub) {
                sessionStorage.clear();
                window.location.href = 'login.html';
                return;
            }

            userId = payload.sub;
            const data = await apiCall(`/users/${userId}`, 'GET');
            responseArea.innerText = JSON.stringify(data, null, 2).replace(/\\n/g, '\n');

            // Verifica se retornou dados v√°lidos (deve ter id ou email)
            if (!data || data.message) {
                alert(data?.message || 'Erro ao carregar dados.');
                sessionStorage.clear();
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('updateName').value = data.name || '';
            document.getElementById('updateEmail').value = data.email || '';
            document.getElementById('updatePhone').value = data.phone || '';
            document.getElementById('updateExperience').value = data.experience || '';
            document.getElementById('updateEducation').value = data.education || '';
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            window.location.href = 'painel.html';
        });

        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const body = {
                name: updateName.value.trim() || null,
                email: updateEmail.value.trim() || null,
                password: updatePassword.value.trim() || null,
                phone: updatePhone.value.trim() || null,
                experience: updateExperience.value.trim() || null,
                education: updateEducation.value.trim() || null
            };

            Object.keys(body).forEach(k => body[k] === null && delete body[k]);

            const data = await apiCall(`/users/${userId}`, 'PATCH', body);
            responseArea.innerText = JSON.stringify(data, null, 2).replace(/\\n/g, '\n');

            // Debug: vamos ver o que est√° retornando
            console.log('Resposta do servidor:', data);
            console.log('Tem ID?', data?.id);
            console.log('Tipo do ID:', typeof data?.id);

            // Verifica se a atualiza√ß√£o foi bem-sucedida
            // O servidor retorna {message: 'User updated successfully'} em caso de sucesso
            if (data && (data.id || data.email || data.message === 'User updated successfully')) {
                // Se n√£o retornou os dados completos, busca novamente
                if (!data.id) {
                    const userData = await apiCall(`/users/${userId}`, 'GET');
                    sessionStorage.setItem('currentUser', JSON.stringify(userData));
                } else {
                    sessionStorage.setItem('currentUser', JSON.stringify(data));
                }
                alert('‚úÖ Dados atualizados com sucesso!');
                window.location.href = 'painel.html';
            } else {
                alert(`‚ö†Ô∏è Erro ao atualizar: ${data?.message || 'Erro desconhecido'}`);
            }
        });
    </script>
</body>

</html>