<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Editar Perfil</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="panel">
        <h2>Editar Perfil</h2>
        <form id="updateForm">
            <label for="updateName">Nome Completo:</label>
            <input type="text" id="updateName" required>

            <label for="updateEmail">Email:</label>
            <input type="email" id="updateEmail">

            <label for="updatePassword">Nova Senha (deixe em branco para não alterar):</label>
            <input type="password" id="updatePassword">

            <label for="updatePhone">Telefone:</label>
            <input type="text" id="updatePhone">

            <label for="updateExperience">Experiência:</label>
            <textarea id="updateExperience"></textarea>

            <label for="updateEducation">Formação:</label>
            <textarea id="updateEducation"></textarea>

            <button type="submit">Salvar Alterações</button>
            <button type="button" id="cancelBtn" class="secondary">Cancelar</button>
        </form>

        <h2>Resposta do Servidor</h2>
        <pre id="responseArea"></pre>
    </div>

    <script src="api.js"></script>
    <script>
        const responseArea = document.getElementById('responseArea');
        let userId = null;

        // Decodifica JWT
        function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const token = sessionStorage.getItem('jwtToken');

            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            const payload = parseJwt(token);
            if (!payload || !payload.sub) {
                sessionStorage.clear();
                window.location.href = 'login.html';
                return;
            }

            userId = payload.sub;

            // Busca dados do usuário
            const data = await apiCall(`/users/${userId}`, 'GET');
            responseArea.textContent = JSON.stringify(data, null, 2);

            if (!data || data.message) {
                alert(data?.message || 'Não foi possível carregar os dados do usuário');
                sessionStorage.clear();
                window.location.href = 'login.html';
                return;
            }

            // Preenche campos do formulário
            document.getElementById('updateName').value = data.name || '';
            document.getElementById('updateEmail').value = data.email || '';
            document.getElementById('updatePhone').value = data.phone || '';
            document.getElementById('updateExperience').value = data.experience || '';
            document.getElementById('updateEducation').value = data.education || '';
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            window.location.href = 'painel.html';
        });

        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const body = {
                name: document.getElementById('updateName').value.trim() || null,
                email: document.getElementById('updateEmail').value.trim() || null,
                password: document.getElementById('updatePassword').value.trim() || null,
                phone: document.getElementById('updatePhone').value.trim() || null,
                experience: document.getElementById('updateExperience').value.trim() || null,
                education: document.getElementById('updateEducation').value.trim() || null
            };

            Object.keys(body).forEach(key => {
                if (body[key] === null) delete body[key];
            });

            const data = await apiCall(`/users/${userId}`, 'PATCH', body);
            responseArea.textContent = JSON.stringify(data, null, 2);

            if (data && !data.message) {
                sessionStorage.setItem('currentUser', JSON.stringify(data));
                alert('✅ Dados atualizados com sucesso!');
                window.location.href = 'painel.html';
            } else {
                alert(`⚠️ Erro ao atualizar: ${data.message}`);
            }
        });

    </script>
</body>

</html>