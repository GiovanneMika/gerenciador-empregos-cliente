<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Login / Cadastro</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="panel">
        <h1>Sistema de Empregos</h1>

        <!-- Formulário de Login -->
        <form id="loginForm">
            <h3>Login</h3>
            <input type="text" id="loginUsername" placeholder="Username" required>
            <input type="password" id="loginPassword" placeholder="Senha" required>
            <button type="submit">Login</button>
        </form>

        <hr>

        <!-- Formulário de Cadastro -->
        <form id="registerForm">
            <h3>Cadastro</h3>
            <input type="text" id="regName" placeholder="Nome Completo" required>
            <input type="text" id="regUsername" placeholder="Username" required>
            <input type="password" id="regPassword" placeholder="Senha" required>
            <button type="submit">Cadastrar</button>
        </form>

        <h2>Resposta do Servidor</h2>
        <pre id="responseArea"></pre>
    </div>

    <script src="api.js"></script>
    <script>
        const responseArea = document.getElementById('responseArea');

        // Função para decodificar JWT
        function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }

        // LOGIN
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const body = {
                username: document.getElementById('loginUsername').value,
                password: document.getElementById('loginPassword').value,
            };

            const data = await apiCall('/login', 'POST', body);
            responseArea.textContent = JSON.stringify(data, null, 2);

            if (data && data.token) {
                const payload = parseJwt(data.token);

                sessionStorage.setItem('jwtToken', data.token);
                if (payload && payload.sub) {
                    sessionStorage.setItem('userId', payload.sub);
                    sessionStorage.setItem('username', payload.username);
                }

                window.location.href = 'painel.html';
            } else if (data && data.message) {
                alert(data.message);
            }
        });

        // LOGIN
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = {
                username: document.getElementById('loginUsername').value,
                password: document.getElementById('loginPassword').value,
            };
            const data = await apiCall('/login', 'POST', body);
            responseArea.textContent = JSON.stringify(data, null, 2);

            if (data && data.token) {
                const payload = parseJwt(data.token);
                sessionStorage.setItem('jwtToken', data.token);
                if (payload && payload.sub) {
                    sessionStorage.setItem('userId', payload.sub);
                    sessionStorage.setItem('username', payload.username);
                }
                window.location.href = 'painel.html';
            } else {
                alert(`⚠️ Login falhou: ${data.message}`);
            }
        });

        // CADASTRO
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = {
                name: document.getElementById('regName').value,
                username: document.getElementById('regUsername').value,
                password: document.getElementById('regPassword').value
            };
            const data = await apiCall('/users', 'POST', body);
            responseArea.textContent = JSON.stringify(data, null, 2);

            if (data.message === 'Created') {
                alert('✅ Usuário cadastrado com sucesso! Agora você pode fazer login.');
            } else {
                alert(`⚠️ Erro no cadastro: ${data.message}`);
            }
        });


    </script>
</body>

</html>