<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Editar Empresa</title>
    <link rel="stylesheet" href="../assets/css/painel.css">
</head>

<body>
    <div class="panel">
        <h2>‚úèÔ∏è Editar Empresa</h2>

        <form id="updateCompanyForm">
            <label for="updateName">Nome da Empresa:</label>
            <input type="text" id="updateName" required>

            <label for="updateBusiness">Ramo de Atua√ß√£o:</label>
            <input type="text" id="updateBusiness" required>

            <label for="updateEmail">Email:</label>
            <input type="email" id="updateEmail" required>

            <label for="updatePassword">Nova Senha (opcional):</label>
            <input type="password" id="updatePassword">

            <h3>üìç Endere√ßo</h3>

            <label for="updateStreet">Rua:</label>
            <input type="text" id="updateStreet" required>

            <label for="updateNumber">N√∫mero:</label>
            <input type="text" id="updateNumber" required pattern="[0-9]+">

            <label for="updateCity">Cidade:</label>
            <input type="text" id="updateCity" required>

            <label for="updateState">Estado:</label>
            <div class="form-group">
                <select id="updateState" required>
                    <option value="">Selecione o Estado</option>
                    <option value="AC">Acre</option>
                    <option value="AL">Alagoas</option>
                    <option value="AP">Amap√°</option>
                    <option value="AM">Amazonas</option>
                    <option value="BA">Bahia</option>
                    <option value="CE">Cear√°</option>
                    <option value="DF">Distrito Federal</option>
                    <option value="ES">Esp√≠rito Santo</option>
                    <option value="GO">Goi√°s</option>
                    <option value="MA">Maranh√£o</option>
                    <option value="MT">Mato Grosso</option>
                    <option value="MS">Mato Grosso do Sul</option>
                    <option value="MG">Minas Gerais</option>
                    <option value="PA">Par√°</option>
                    <option value="PB">Para√≠ba</option>
                    <option value="PR">Paran√°</option>
                    <option value="PE">Pernambuco</option>
                    <option value="PI">Piau√≠</option>
                    <option value="RJ">Rio de Janeiro</option>
                    <option value="RN">Rio Grande do Norte</option>
                    <option value="RS">Rio Grande do Sul</option>
                    <option value="RO">Rond√¥nia</option>
                    <option value="RR">Roraima</option>
                    <option value="SC">Santa Catarina</option>
                    <option value="SP">S√£o Paulo</option>
                    <option value="SE">Sergipe</option>
                    <option value="TO">Tocantins</option>
                </select>
            </div>

            <label for="updatePhone">Telefone (apenas n√∫meros):</label>
            <input type="tel" id="updatePhone" required pattern="[0-9]{10,14}">

            <button type="submit">üíæ Salvar Altera√ß√µes</button>
            <button type="button" id="cancelBtn" class="secondary">‚¨ÖÔ∏è Cancelar</button>
        </form>

        <h2>üì° Resposta do Servidor</h2>
        <pre id="responseArea">Aguardando resposta...</pre>
    </div>

    <script src="../assets/js/protocol-validator.js"></script>
    <script src="../assets/js/company-api.js"></script>
    <script>
        const responseArea = document.getElementById('responseArea');
        let companyId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const token = sessionStorage.getItem('companyToken');
            companyId = sessionStorage.getItem('companyId');

            if (!token || !companyId || !isTokenValid()) {
                alert('‚ùå Sess√£o inv√°lida. Redirecionando para login...');
                window.location.href = 'company-login.html';
                return;
            }

            // Carrega dados atuais da empresa
            const data = await companyApiCall(`/companies/${companyId}`, 'GET');
            responseArea.innerText = JSON.stringify(data, null, 2);

            if (data.status === 200) {
                // Preenche os campos com os dados atuais
                document.getElementById('updateName').value = data.name || '';
                document.getElementById('updateBusiness').value = data.business || '';
                document.getElementById('updateEmail').value = data.email || '';
                document.getElementById('updateStreet').value = data.street || '';
                document.getElementById('updateNumber').value = data.number || '';
                document.getElementById('updateCity').value = data.city || '';
                document.getElementById('updateState').value = data.state || '';
                document.getElementById('updatePhone').value = data.phone || '';
            } else if (data.status === 401) {
                alert('‚ùå Token inv√°lido. Redirecionando para login...');
                sessionStorage.clear();
                window.location.href = 'company-login.html';
            } else {
                alert(`‚ùå Erro ao carregar dados: ${data.message || 'Erro desconhecido'}`);
                window.location.href = 'company-panel.html';
            }
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            window.location.href = 'company-panel.html';
        });

        document.getElementById('updateCompanyForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Valida√ß√µes do frontend
            const phone = document.getElementById('updatePhone').value.trim();
            const number = document.getElementById('updateNumber').value.trim();
            
            if (!/^[0-9]{10,14}$/.test(phone)) {
                alert('‚ùå Telefone deve conter apenas n√∫meros (10-14 d√≠gitos)');
                return;
            }
            
            if (!/^[0-9]{1,8}$/.test(number)) {
                alert('‚ùå N√∫mero deve conter apenas d√≠gitos (1-8 caracteres)');
                return;
            }

            const body = {
                name: document.getElementById('updateName').value.trim(),
                business: document.getElementById('updateBusiness').value.trim(),
                email: document.getElementById('updateEmail').value.trim(),
                street: document.getElementById('updateStreet').value.trim(),
                number: number,
                city: document.getElementById('updateCity').value.trim(),
                state: document.getElementById('updateState').value,
                phone: phone
            };

            // Inclui senha apenas se foi preenchida
            const password = document.getElementById('updatePassword').value.trim();
            if (password) {
                body.password = password;
            }

            const data = await companyApiCall(`/companies/${companyId}`, 'PATCH', body);
            responseArea.innerText = JSON.stringify(data, null, 2);

            if (data.status === 200) {
                alert('‚úÖ Dados atualizados com sucesso!');
                navigateAfterApiCall('company-panel.html', 500);
            } else if (data.status === 422) {
                alert(handleValidationError(data));
            } else if (data.status === 409) {
                alert('‚ùå Nome da empresa j√° existe. Escolha outro nome.');
            } else if (data.status === 403) {
                alert('‚ùå Acesso negado. Voc√™ s√≥ pode editar sua pr√≥pria empresa.');
            } else if (data.status === 404) {
                alert('‚ùå Empresa n√£o encontrada.');
            } else {
                alert(`‚ùå Erro ao atualizar: ${data.message || 'Erro desconhecido'}`);
            }
        });

        // Formata√ß√£o autom√°tica do telefone
        document.getElementById('updatePhone').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // Formata√ß√£o autom√°tica do n√∫mero
        document.getElementById('updateNumber').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });
    </script>
</body>

</html>