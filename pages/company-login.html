<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Login Empresa - Sistema de Empregos</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://kit.fontawesome.com/a2e0e6ad4b.js" crossorigin="anonymous"></script>
</head>

<body>
    <!-- Indicador de Servidor -->
    <div class="server-indicator" onclick="window.location.href='config-server.html'" title="Clique para configurar">
        <span class="status-dot"></span>
        <span id="serverUrl">Carregando...</span>
    </div>

    <div class="panel">
        <h1>ğŸ¢ Login Empresa</h1>
        <form id="companyLoginForm">
            <div class="form-group">
                <input type="text" id="loginUsername" placeholder=" " required>
                <label for="loginUsername">Username</label>
                <i class="fa-solid fa-user"></i>
            </div>

            <div class="form-group">
                <input type="password" id="loginPassword" placeholder=" " required>
                <label for="loginPassword">Senha</label>
                <i class="fa-solid fa-lock"></i>
            </div>

            <button type="submit"><i class="fa-solid fa-right-to-bracket"></i> Entrar</button>
        </form>

        <p class="link">NÃ£o tem conta? <a href="company-register.html">Cadastre sua empresa</a></p>
        <p class="link"><a href="login.html">ğŸ§ Login como Candidato</a></p>
        <p class="link"><a href="config-server.html">âš™ï¸ Configurar Servidor</a></p>

        <pre id="responseArea"></pre>
    </div>

    <script src="../assets/js/protocol-validator.js"></script>
    <script src="../assets/js/company-api.js"></script>
    <script>
        // Atualiza indicador de servidor
        document.getElementById('serverUrl').textContent = getApiBase();

        // Redireciona se jÃ¡ estiver logado
        if (sessionStorage.getItem('companyToken') && isTokenValid()) {
            window.location.href = 'company-panel.html';
        }

        const responseArea = document.getElementById('responseArea');

        document.getElementById('companyLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const body = {
                username: document.getElementById('loginUsername').value.trim(),
                password: document.getElementById('loginPassword').value.trim()
            };

            const data = await companyApiCall('/login', 'POST', body);
            responseArea.textContent = JSON.stringify(data, null, 2);

            if (data.status === 200 && data.token) {
                // Decodifica o token para obter informaÃ§Ãµes da empresa
                const payload = parseJwt(data.token);

                if (payload && payload.role === 'company') {
                    // Salva dados da sessÃ£o
                    sessionStorage.setItem('companyToken', data.token);
                    const companyId = payload.sub;
                    sessionStorage.setItem('companyId', companyId);
                    sessionStorage.setItem('companyUsername', payload.username);

                    alert('âœ… Login realizado com sucesso!');
                    // Aguarda um pouco para garantir que a resposta aparece no Network
                    setTimeout(() => {
                        window.location.href = 'company-panel.html';
                    }, 500);
                } else {
                    alert('âŒ Token invÃ¡lido. Tente novamente.');
                }
            } else if (data.status === 401) {
                alert('âŒ Credenciais invÃ¡lidas. Verifique username e senha.');
            } else {
                alert(`âŒ Erro no login: ${data.message || 'Falha desconhecida'}`);
            }
        });
    </script>
</body>

</html>