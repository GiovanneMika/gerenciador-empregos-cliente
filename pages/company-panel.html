<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Painel da Empresa</title>
    <link rel="stylesheet" href="../assets/css/painel.css">
</head>

<body>
    <div class="panel">
        <h2>ğŸ¢ Painel da Empresa</h2>
        <div id="companyInfo" class="user-info"></div>

        <hr>

        <h3>ğŸ“‹ GestÃ£o de Vagas</h3>
        <button id="myJobsBtn" class="primary">ğŸ“‹ Minhas Vagas</button>
        <button id="newJobBtn" class="success">â• Cadastrar Nova Vaga</button>
        <button id="searchJobsBtn" class="info">ğŸ” Buscar Vagas</button>

        <hr>

        <h3>âš™ï¸ ConfiguraÃ§Ãµes</h3>
        <button id="editBtn">âœï¸ Editar Dados</button>
        <button id="deleteBtn" class="danger">ğŸ—‘ï¸ Deletar Empresa</button>
        <button id="logoutBtn" class="secondary">ğŸšª Logout</button>

        <h2>ğŸ“¡ Resposta do Servidor</h2>
        <pre id="responseArea">Aguardando resposta...</pre>
    </div>

    <script src="../assets/js/protocol-validator.js"></script>
    <script src="../assets/js/company-api.js"></script>
    <script src="../assets/js/jobs-api.js"></script>
    <script>
        const companyInfoDiv = document.getElementById('companyInfo');
        const responseArea = document.getElementById('responseArea');

        document.addEventListener('DOMContentLoaded', async () => {
            const token = sessionStorage.getItem('companyToken');
            const companyId = sessionStorage.getItem('companyId');

            if (!token || !companyId || !isTokenValid()) {
                alert('âŒ SessÃ£o invÃ¡lida. Redirecionando para login...');
                window.location.href = 'company-login.html';
                return;
            }

            // Busca dados da empresa
            const data = await companyApiCall(`/companies/${companyId}`, 'GET');
            responseArea.innerText = JSON.stringify(data, null, 2);

            if (data.status === 200 && (data.name || data.nome || data.company_name)) {
                // Helper function to get field value with fallbacks for alternative names
                const getField = (primary, ...alternatives) => {
                    if (data[primary] !== undefined && data[primary] !== null) return data[primary];
                    for (const alt of alternatives) {
                        if (data[alt] !== undefined && data[alt] !== null) return data[alt];
                    }
                    return null;
                };

                const name = getField('name', 'nome', 'company_name', 'companyName') || 'NÃ£o informado';
                const business = getField('business', 'ramo', 'business_type', 'businessType', 'industry') || 'NÃ£o informado';
                const username = getField('username', 'user_name', 'userName', 'login') || 'NÃ£o informado';
                const email = getField('email', 'e_mail', 'emailAddress') || 'NÃ£o informado';
                const phone = getField('phone', 'telefone', 'telephone', 'phoneNumber') || 'NÃ£o informado';
                const street = getField('street', 'rua', 'address', 'endereco') || '';
                const number = getField('number', 'numero', 'addressNumber', 'num') || '';
                const city = getField('city', 'cidade', 'municipio') || '';
                const state = getField('state', 'estado', 'uf', 'province') || '';

                // Build address string, handling missing parts
                let addressParts = [];
                if (street) addressParts.push(street);
                if (number) addressParts.push(number);
                let address = addressParts.join(', ') || 'NÃ£o informado';
                if (city || state) {
                    address += ` - ${city || ''}${city && state ? '/' : ''}${state || ''}`;
                }

                companyInfoDiv.innerHTML = `
                    <p><strong>Nome:</strong> ${name}</p>
                    <p><strong>Ramo:</strong> ${business}</p>
                    <p><strong>Username:</strong> ${username}</p>
                    <p><strong>Email:</strong> ${email}</p>
                    <p><strong>Telefone:</strong> ${phone}</p>
                    <p><strong>EndereÃ§o:</strong> ${address}</p>
                `;
            } else if (data.status === 401) {
                alert('âŒ Token invÃ¡lido. Redirecionando para login...');
                sessionStorage.clear();
                window.location.href = 'company-login.html';
            } else if (data.status === 404) {
                alert('âŒ Empresa nÃ£o encontrada.');
                sessionStorage.clear();
                window.location.href = 'company-login.html';
            } else {
                alert(`âŒ Erro ao carregar dados: ${data.message || 'Erro desconhecido'}`);
            }
        });

        document.getElementById('editBtn').addEventListener('click', () => {
            window.location.href = 'company-edit.html';
        });

        document.getElementById('myJobsBtn').addEventListener('click', () => {
            window.location.href = 'my-jobs.html';
        });

        document.getElementById('newJobBtn').addEventListener('click', () => {
            window.location.href = 'job-create.html';
        });

        document.getElementById('searchJobsBtn').addEventListener('click', () => {
            window.location.href = 'job-search.html';
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            const data = await companyLogout();
            responseArea.innerText = JSON.stringify(data, null, 2);

            alert('âœ… Logout realizado com sucesso.');
            navigateAfterApiCall('company-login.html', 500);
        });

        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (confirm('âŒ ATENÃ‡ÃƒO: Tem certeza que deseja deletar sua empresa?\n\nEsta aÃ§Ã£o Ã© IRREVERSÃVEL e todos os dados serÃ£o perdidos!')) {
                const companyId = sessionStorage.getItem('companyId');
                const data = await companyApiCall(`/companies/${companyId}`, 'DELETE');
                responseArea.innerText = JSON.stringify(data, null, 2);

                if (data.status === 200) {
                    alert('âœ… Empresa deletada com sucesso.');
                    sessionStorage.clear();
                    navigateAfterApiCall('company-login.html', 500);
                } else if (data.status === 409) {
                    alert('âŒ NÃ£o Ã© possÃ­vel deletar a empresa: ela possui vagas ativas.');
                } else {
                    alert(`âŒ Erro ao deletar empresa: ${data.message || 'Erro desconhecido'}`);
                }
            }
        });
    </script>
</body>

</html>