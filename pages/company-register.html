<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Empresa - Sistema de Empregos</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://kit.fontawesome.com/a2e0e6ad4b.js" crossorigin="anonymous"></script>
</head>
<body>
    <!-- Indicador de Servidor -->
    <div class="server-indicator" onclick="window.location.href='config-server.html'" title="Clique para configurar">
        <span class="status-dot"></span>
        <span id="serverUrl">Carregando...</span>
    </div>

    <div class="panel">
        <h1>üè¢ Cadastro de Empresa</h1>
        <form id="companyRegisterForm">
            <div class="form-group">
                <input type="text" id="companyName" placeholder=" " required>
                <label for="companyName">Nome da Empresa *</label>
                <i class="fa-solid fa-building"></i>
            </div>

            <div class="form-group">
                <input type="text" id="companyBusiness" placeholder=" " required>
                <label for="companyBusiness">Ramo de Atua√ß√£o *</label>
                <i class="fa-solid fa-industry"></i>
            </div>

            <div class="form-group">
                <input type="text" id="companyUsername" placeholder=" " required>
                <label for="companyUsername">Username *</label>
                <i class="fa-solid fa-user"></i>
            </div>

            <div class="form-group">
                <input type="password" id="companyPassword" placeholder=" " required>
                <label for="companyPassword">Senha *</label>
                <i class="fa-solid fa-lock"></i>
            </div>

            <h3>üìç Endere√ßo</h3>

            <div class="form-group">
                <input type="text" id="companyStreet" placeholder=" " required>
                <label for="companyStreet">Rua *</label>
                <i class="fa-solid fa-road"></i>
            </div>

            <div class="form-group">
                <input type="text" id="companyNumber" placeholder=" " required pattern="[0-9]+">
                <label for="companyNumber">N√∫mero *</label>
                <i class="fa-solid fa-hashtag"></i>
            </div>

            <div class="form-group">
                <input type="text" id="companyCity" placeholder=" " required>
                <label for="companyCity">Cidade *</label>
                <i class="fa-solid fa-city"></i>
            </div>

            <div class="form-group">
                <select id="companyState" required>
                    <option value="">Selecione o Estado *</option>
                    <option value="AC">Acre</option>
                    <option value="AL">Alagoas</option>
                    <option value="AP">Amap√°</option>
                    <option value="AM">Amazonas</option>
                    <option value="BA">Bahia</option>
                    <option value="CE">Cear√°</option>
                    <option value="DF">Distrito Federal</option>
                    <option value="ES">Esp√≠rito Santo</option>
                    <option value="GO">Goi√°s</option>
                    <option value="MA">Maranh√£o</option>
                    <option value="MT">Mato Grosso</option>
                    <option value="MS">Mato Grosso do Sul</option>
                    <option value="MG">Minas Gerais</option>
                    <option value="PA">Par√°</option>
                    <option value="PB">Para√≠ba</option>
                    <option value="PR">Paran√°</option>
                    <option value="PE">Pernambuco</option>
                    <option value="PI">Piau√≠</option>
                    <option value="RJ">Rio de Janeiro</option>
                    <option value="RN">Rio Grande do Norte</option>
                    <option value="RS">Rio Grande do Sul</option>
                    <option value="RO">Rond√¥nia</option>
                    <option value="RR">Roraima</option>
                    <option value="SC">Santa Catarina</option>
                    <option value="SP">S√£o Paulo</option>
                    <option value="SE">Sergipe</option>
                    <option value="TO">Tocantins</option>
                </select>
                <i class="fa-solid fa-map-location-dot"></i>
            </div>

            <h3>üìû Contato</h3>

            <div class="form-group">
                <input type="tel" id="companyPhone" placeholder=" " required pattern="[0-9]{10,14}">
                <label for="companyPhone">Telefone * (apenas n√∫meros)</label>
                <i class="fa-solid fa-phone"></i>
            </div>

            <div class="form-group">
                <input type="email" id="companyEmail" placeholder=" " required>
                <label for="companyEmail">Email *</label>
                <i class="fa-solid fa-envelope"></i>
            </div>

            <button type="submit"><i class="fa-solid fa-building-user"></i> Cadastrar Empresa</button>
        </form>

        <p class="link">J√° tem conta? <a href="company-login.html">Fa√ßa login</a></p>
        <p class="link"><a href="login.html">üßç Login como Candidato</a></p>
        <p class="link"><a href="config-server.html">‚öôÔ∏è Configurar Servidor</a></p>

        <pre id="responseArea"></pre>
    </div>

    <script src="../assets/js/protocol-validator.js"></script>
    <script src="../assets/js/company-api.js"></script>
    <script>
        // Atualiza indicador de servidor
        document.getElementById('serverUrl').textContent = getApiBase();

        // Redireciona se j√° estiver logado
        if (sessionStorage.getItem('companyToken') && isTokenValid()) {
            window.location.href = 'company-panel.html';
        }

        const responseArea = document.getElementById('responseArea');

        document.getElementById('companyRegisterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Valida√ß√µes do frontend
            const phone = document.getElementById('companyPhone').value.trim();
            const number = document.getElementById('companyNumber').value.trim();
            
            if (!/^[0-9]{10,14}$/.test(phone)) {
                alert('‚ùå Telefone deve conter apenas n√∫meros (10-14 d√≠gitos)');
                return;
            }
            
            if (!/^[0-9]{1,8}$/.test(number)) {
                alert('‚ùå N√∫mero deve conter apenas d√≠gitos (1-8 caracteres)');
                return;
            }

            const body = {
                name: document.getElementById('companyName').value.trim(),
                business: document.getElementById('companyBusiness').value.trim(),
                username: document.getElementById('companyUsername').value.trim(),
                password: document.getElementById('companyPassword').value.trim(),
                street: document.getElementById('companyStreet').value.trim(),
                number: number,
                city: document.getElementById('companyCity').value.trim(),
                state: document.getElementById('companyState').value,
                phone: phone,
                email: document.getElementById('companyEmail').value.trim()
            };

            const data = await companyApiCall('/companies', 'POST', body);
            responseArea.textContent = JSON.stringify(data, null, 2);

            if (data.status === 201) {
                alert('‚úÖ Empresa cadastrada com sucesso! Agora voc√™ pode fazer login.');
                navigateAfterApiCall('company-login.html', 500);
            } else if (data.status === 409) {
                if (data.message.includes('name')) {
                    alert('‚ùå Nome da empresa j√° existe. Escolha outro nome.');
                } else if (data.message.includes('Username')) {
                    alert('‚ùå Username j√° existe. Escolha outro username.');
                } else {
                    alert(`‚ùå ${data.message}`);
                }
            } else if (data.status === 422) {
                alert(handleValidationError(data));
            } else {
                alert(`‚ùå Erro no cadastro: ${data.message || 'Falha desconhecida'}`);
            }
        });

        // Formata√ß√£o autom√°tica do telefone
        document.getElementById('companyPhone').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // Formata√ß√£o autom√°tica do n√∫mero
        document.getElementById('companyNumber').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });
    </script>
</body>
</html>