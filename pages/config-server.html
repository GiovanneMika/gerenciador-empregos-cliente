<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Configurar Servidor - Sistema de Empregos</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/config-server.css">
    <script src="https://kit.fontawesome.com/a2e0e6ad4b.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="panel">
        <h1>‚öôÔ∏è Configurar Servidor</h1>
        
        <div class="current-server">
            <strong>üåê Servidor Atual:</strong>
            <div id="currentServer">Carregando...</div>
        </div>

        <div class="config-info">
            <h3>üí° Como usar:</h3>
            <p>Digite o endere√ßo IP e porta do servidor da API.</p>
            <p><strong>Exemplos v√°lidos:</strong></p>
            <ul>
                <li><code>http://localhost:8000</code> - Servidor local</li>
                <li><code>http://192.168.1.10:8000</code> - Servidor na rede local</li>
                <li><code>http://26.13.125.160:8000</code> - Servidor remoto (Hamachi/Radmin)</li>
                <li><code>http://meuservidor.com:8000</code> - Servidor com dom√≠nio</li>
            </ul>
            <p><strong>‚ö†Ô∏è Importante:</strong> N√£o use <code>/api</code> no final da URL!</p>
        </div>

        <form id="configForm">
            <div class="form-group">
                <input 
                    type="text" 
                    id="serverUrl" 
                    placeholder=" " 
                    required
                    pattern="https?://.+"
                    title="URL deve come√ßar com http:// ou https://">
                <label for="serverUrl">URL do Servidor</label>
                <i class="fa-solid fa-server"></i>
            </div>

            <div id="testResult"></div>

            <div class="button-group">
                <button type="button" id="testBtn">
                    <i class="fa-solid fa-vial"></i> Testar Conex√£o
                </button>
                <button type="submit">
                    <i class="fa-solid fa-floppy-disk"></i> Salvar
                </button>
            </div>

            <button type="button" class="secondary" onclick="history.back()">
                <i class="fa-solid fa-arrow-left"></i> Voltar
            </button>
        </form>
    </div>

    <script src="../assets/js/api.js"></script>
    <script>
        // üîí PROTE√á√ÉO: Redireciona se usu√°rio estiver logado
        if (sessionStorage.getItem('jwtToken')) {
            alert('‚ö†Ô∏è N√£o √© poss√≠vel alterar o servidor ap√≥s fazer login.\n\nFa√ßa logout primeiro se precisar mudar de servidor.');
            window.location.href = 'painel.html';
        }

        const serverUrlInput = document.getElementById('serverUrl');
        const currentServerDiv = document.getElementById('currentServer');
        const testResult = document.getElementById('testResult');

        // Mostra o servidor atual
        function updateCurrentServer() {
            currentServerDiv.textContent = getApiBase();
        }
        updateCurrentServer();

        // Preenche o input com o servidor atual
        serverUrlInput.value = getApiBase();

        // Testar conex√£o
        document.getElementById('testBtn').addEventListener('click', async () => {
            const url = serverUrlInput.value.trim();
            
            if (!url) {
                testResult.innerHTML = '<div class="test-result test-error">‚ùå Digite uma URL v√°lida</div>';
                return;
            }

            // Valida formato b√°sico
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                testResult.innerHTML = '<div class="test-result test-error">‚ùå URL deve come√ßar com http:// ou https://</div>';
                return;
            }

            testResult.innerHTML = '<div class="test-result">‚è≥ Testando conex√£o...</div>';

            const isConnected = await testServerConnection(url);
            
            if (isConnected) {
                testResult.innerHTML = '<div class="test-result test-success">‚úÖ Conex√£o bem-sucedida! Servidor acess√≠vel.</div>';
            } else {
                testResult.innerHTML = '<div class="test-result test-error">‚ùå Falha na conex√£o. Verifique se:<br>‚Ä¢ O servidor est√° rodando<br>‚Ä¢ O IP/porta est√£o corretos<br>‚Ä¢ N√£o h√° firewall bloqueando</div>';
            }
        });

        // Salvar configura√ß√£o
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const url = serverUrlInput.value.trim();
            
            if (!url) {
                alert('‚ùå Digite uma URL v√°lida');
                return;
            }

            // Valida formato b√°sico
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert('‚ùå URL deve come√ßar com http:// ou https://');
                return;
            }

            // Testa antes de salvar
            testResult.innerHTML = '<div class="test-result">‚è≥ Testando conex√£o antes de salvar...</div>';
            const isConnected = await testServerConnection(url);
            
            if (isConnected) {
                setApiBase(url);
                updateCurrentServer();
                testResult.innerHTML = '<div class="test-result test-success">‚úÖ Configura√ß√£o salva com sucesso!</div>';
                
                setTimeout(() => {
                    history.back();
                }, 1500);
            } else {
                const confirmSave = confirm(
                    '‚ö†Ô∏è N√£o foi poss√≠vel conectar ao servidor.\n\n' +
                    'Deseja salvar mesmo assim?\n' +
                    '(Pode ser que o servidor esteja offline no momento)'
                );
                
                if (confirmSave) {
                    setApiBase(url);
                    updateCurrentServer();
                    testResult.innerHTML = '<div class="test-result test-success">‚úÖ Configura√ß√£o salva (sem teste de conex√£o)</div>';
                    
                    setTimeout(() => {
                        history.back();
                    }, 1500);
                } else {
                    testResult.innerHTML = '<div class="test-result test-error">‚ùå Configura√ß√£o n√£o salva. Verifique o servidor.</div>';
                }
            }
        });
    </script>
</body>
</html>
