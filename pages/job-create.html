<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Vaga</title>
    <link rel="stylesheet" href="../assets/css/painel.css">
    <style>
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .required::after {
            content: ' *';
            color: var(--danger-color);
        }

        .btn-submit {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-submit:hover {
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.4);
        }

        .btn-back {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
        }

        .error-message {
            background: #fff5f5;
            border: 2px solid #fc8181;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #c53030;
            display: none;
        }

        .success-message {
            background: #f0fff4;
            border: 2px solid #68d391;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #276749;
            display: none;
        }
    </style>
</head>

<body>
    <div class="panel">
        <h2>üìã Cadastrar Nova Vaga</h2>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <form id="jobForm">
            <div class="form-group">
                <label for="title" class="required">T√≠tulo da Vaga</label>
                <input type="text" id="title" name="title" placeholder="Ex: Desenvolvedor Full Stack" 
                       minlength="3" maxlength="150" required>
                <small>Entre 3 e 150 caracteres</small>
            </div>

            <div class="form-group">
                <label for="area" class="required">√Årea de Atua√ß√£o</label>
                <select id="area" name="area" required>
                    <option value="">Selecione a √°rea...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description" class="required">Descri√ß√£o da Vaga</label>
                <textarea id="description" name="description" 
                          placeholder="Descreva as responsabilidades, requisitos, benef√≠cios..." 
                          minlength="10" maxlength="5000" required></textarea>
                <small>Entre 10 e 5000 caracteres</small>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="state" class="required">Estado</label>
                    <select id="state" name="state" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="city" class="required">Cidade</label>
                    <input type="text" id="city" name="city" placeholder="Ex: S√£o Paulo" required>
                </div>
            </div>

            <div class="form-group">
                <label for="salary">Sal√°rio (opcional)</label>
                <input type="number" id="salary" name="salary" placeholder="Ex: 3500.00" 
                       min="0" step="0.01">
                <small>Deixe vazio para "A combinar"</small>
            </div>

            <button type="submit" class="btn-submit">‚úÖ Cadastrar Vaga</button>
            <button type="button" class="btn-back" onclick="goBack()">‚¨ÖÔ∏è Voltar</button>
        </form>

        <h3>üì° Resposta do Servidor</h3>
        <pre id="responseArea">Aguardando envio...</pre>
    </div>

    <script src="../assets/js/jobs-api.js"></script>
    <script>
        const form = document.getElementById('jobForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const responseArea = document.getElementById('responseArea');

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            // Verifica se √© empresa logada
            if (!isCompanyLogged()) {
                alert('‚ùå Apenas empresas podem cadastrar vagas.');
                window.location.href = 'company-login.html';
                return;
            }

            // Popula selects
            populateAreasSelect(document.getElementById('area'));
            populateStatesSelect(document.getElementById('state'));
        });

        // Submit do formul√°rio
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            hideMessages();

            const jobData = {
                title: document.getElementById('title').value.trim(),
                area: document.getElementById('area').value,
                description: document.getElementById('description').value.trim(),
                state: document.getElementById('state').value,
                city: document.getElementById('city').value.trim()
            };

            // Adiciona sal√°rio apenas se preenchido
            const salary = document.getElementById('salary').value;
            if (salary && parseFloat(salary) > 0) {
                jobData.salary = parseFloat(salary);
            }

            const data = await createJob(jobData);
            responseArea.textContent = JSON.stringify(data, null, 2);

            if (data.status === 201) {
                showSuccess('‚úÖ Vaga cadastrada com sucesso!');
                form.reset();
                
                setTimeout(() => {
                    if (confirm('Deseja cadastrar outra vaga?')) {
                        hideMessages();
                    } else {
                        navigateAfterApiCall('my-jobs.html', 500);
                    }
                }, 1500);
            } else if (data.status === 401) {
                showError('‚ùå Token inv√°lido. Fa√ßa login novamente.');
                setTimeout(() => {
                    navigateAfterApiCall('company-login.html', 500);
                }, 2500);
            } else if (data.status === 403) {
                showError('‚ùå Apenas empresas podem cadastrar vagas.');
            } else if (data.status === 422) {
                const errorText = formatJobValidationErrors(data.details);
                showError('‚ùå Erro de valida√ß√£o:\n' + errorText);
            } else {
                showError('‚ùå Erro: ' + (data.message || 'Erro desconhecido'));
            }
        });

        function showError(message) {
            errorMessage.style.display = 'block';
            errorMessage.textContent = message;
            errorMessage.style.whiteSpace = 'pre-line';
        }

        function showSuccess(message) {
            successMessage.style.display = 'block';
            successMessage.textContent = message;
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        function goBack() {
            window.location.href = 'company-panel.html';
        }
    </script>
</body>

</html>
