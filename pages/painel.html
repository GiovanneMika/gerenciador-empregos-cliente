<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Painel do UsuÃ¡rio</title>
    <link rel="stylesheet" href="../assets/css/painel.css">
</head>

<body>
    <div class="panel">
        <h2>ğŸ‘¤ Painel do UsuÃ¡rio</h2>
        <div id="userInfo" class="user-info"></div>

        <hr>

        <h3>ğŸ’¼ Vagas de Emprego</h3>
        <button id="searchJobsBtn" class="primary">ğŸ” Buscar Vagas</button>
        <button id="myApplicationsBtn" class="info">ğŸ“ Minhas Candidaturas</button>

        <hr>

        <h3>âš™ï¸ ConfiguraÃ§Ãµes</h3>
        <button id="editBtn">âœï¸ Editar Dados</button>
        <button id="deleteBtn" class="danger">ğŸ—‘ï¸ Deletar Conta</button>
        <button id="logoutBtn" class="secondary">ğŸšª Logout</button>

        <h2>ğŸ“¡ Resposta do Servidor</h2>
        <pre id="responseArea">Aguardando resposta...</pre>
    </div>

    <script src="../assets/js/protocol-validator.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/jobs-api.js"></script>
    <script>
        const userInfoDiv = document.getElementById('userInfo');
        const responseArea = document.getElementById('responseArea');

        document.addEventListener('DOMContentLoaded', async () => {
            const token = sessionStorage.getItem('jwtToken');
            const userId = sessionStorage.getItem('userId');

            if (!token || !userId) {
                window.location.href = 'login.html';
                return;
            }

            const data = await apiCall(`/users/${userId}`, 'GET');
            delete data.status;
            responseArea.innerText = JSON.stringify(data, null, 2).replace(/\\n/g, '\n');

            if (data && (data.username || data.user_name || data.userName)) {
                // Helper function to get field value with fallbacks for alternative names
                const getField = (primary, ...alternatives) => {
                    if (data[primary] !== undefined && data[primary] !== null) return data[primary];
                    for (const alt of alternatives) {
                        if (data[alt] !== undefined && data[alt] !== null) return data[alt];
                    }
                    return null;
                };

                const name = getField('name', 'nome', 'full_name', 'fullName') || 'NÃ£o informado';
                const username = getField('username', 'user_name', 'userName', 'login') || 'NÃ£o informado';
                const email = getField('email', 'e_mail', 'emailAddress') || 'NÃ£o informado';
                const phone = getField('phone', 'telefone', 'telephone', 'cellphone', 'phoneNumber') || 'NÃ£o informado';
                const experience = getField('experience', 'experiencia', 'experiences', 'work_experience') || 'NÃ£o informada';
                const education = getField('education', 'educacao', 'formacao', 'formation', 'academic') || 'NÃ£o informada';

                userInfoDiv.innerHTML = `
                    <p><strong>Nome:</strong> ${name}</p>
                    <p><strong>UsuÃ¡rio:</strong> ${username}</p>
                    <p><strong>Email:</strong> ${email}</p>
                    <p><strong>Telefone:</strong> ${phone}</p>
                    <p><strong>ExperiÃªncia:</strong> ${experience}</p>
                    <p><strong>FormaÃ§Ã£o:</strong> ${education}</p>
                `;
            } else if (data && data.message) {
                // Erro de API (conexÃ£o, token expirado, etc.) - mostra erro mas nÃ£o faz loop
                userInfoDiv.innerHTML = `<p class="error">Erro ao carregar dados: ${data.message}</p>`;
                // SÃ³ limpa sessÃ£o se for erro de autenticaÃ§Ã£o (401/403)
                if (data.message.includes('401') || data.message.includes('403') || 
                    data.message.includes('Unauthorized') || data.message.includes('Token')) {
                    alert('SessÃ£o expirada. FaÃ§a login novamente.');
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                }
            } else {
                // UsuÃ¡rio realmente nÃ£o encontrado
                alert('UsuÃ¡rio nÃ£o encontrado.');
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        });

        document.getElementById('editBtn').addEventListener('click', () => {
            window.location.href = 'editar.html';
        });

        document.getElementById('searchJobsBtn').addEventListener('click', () => {
            window.location.href = 'job-search.html';
        });

        document.getElementById('myApplicationsBtn').addEventListener('click', () => {
            window.location.href = 'my-applications.html';
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            const data = await apiCall('/logout', 'POST');
            responseArea.innerText = JSON.stringify(data, null, 2).replace(/\\n/g, '\n');
            alert(data.message || 'SessÃ£o encerrada.');
            sessionStorage.clear();
            navigateAfterApiCall('login.html', 500);
        });

        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (confirm('Tem certeza que deseja deletar sua conta?')) {
                const userId = sessionStorage.getItem('userId');
                const data = await apiCall(`/users/${userId}`, 'DELETE');
                responseArea.innerText = JSON.stringify(data, null, 2).replace(/\\n/g, '\n');

                if (data.message && data.message.includes('deleted')) {
                    alert('Conta deletada com sucesso.');
                    sessionStorage.clear();
                    navigateAfterApiCall('login.html', 500);
                } else {
                    alert(data.message || 'Erro ao deletar conta.');
                }
            }
        });
    </script>
</body>

</html>